name: Single Commit Check

on:
  pull_request:
    branches: [ main, master ]

jobs:
  check-single-commit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.head_ref }}
      
      - name: Verify single commit in PR
        run: |
          BASE_BRANCH="${GITHUB_BASE_REF:-main}"
          
          git fetch origin "$BASE_BRANCH"
          
          MERGE_BASE=$(git merge-base HEAD origin/$BASE_BRANCH)
          
          COMMIT_COUNT=$(git rev-list --count $MERGE_BASE..HEAD)
          
          echo "Merge base: $MERGE_BASE"
          echo "Commits in this PR: $COMMIT_COUNT"
          echo ""
          echo "Commits:"
          git log --oneline $MERGE_BASE..HEAD
          
          if [ "$COMMIT_COUNT" -eq 0 ]; then
            echo "No new commits in this PR"
            exit 1
          elif [ "$COMMIT_COUNT" -eq 1 ]; then
            echo "Single commit policy satisfied"
            exit 0
          else
            echo "Multiple commits detected in this PR ($COMMIT_COUNT commits)"
            echo "Please squash your commits into one using:"
            echo "  git rebase -i $MERGE_BASE"
            echo "Or reset and recommit:"
            echo "  git reset --soft $MERGE_BASE"
            echo "  git commit -m 'Your message'"
            exit 1
          fi